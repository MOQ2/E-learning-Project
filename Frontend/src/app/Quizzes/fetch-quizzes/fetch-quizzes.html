@if (loading) {
  <div class="d-flex justify-content-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden text-primary">Loading...</span>
    </div>
  </div>
}

@if (!loading && quizzes.length === 0) {
  <div>No quizzes available.</div>
}
@if (!loading && quizzes.length > 0) {
  <ul class="list-group" >
    @for (quiz of quizzes ; track quiz.id) {
      <li class="list-group-item">
        <span (click)="openQuiz(quiz)"> {{quiz.title}} </span>
        <button class="btn btn-edit" (click)="openEditModal(quiz)">Edit</button>
      </li>
    }
  </ul>
}

<button class="btn btn-add-quiz mt-3" (click)="openAddModal()">Add New Quiz</button>

@if (openModal) {
  <div class="modal fade show d-block modal-lg">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-4 shadow-lg border-0 rounded-4" (click)="$event.stopPropagation()">

        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold text-primary">
            {{ editingQuiz ? 'Edit Quiz' : 'Add Quiz' }}
          </h5>
          <button type="button" class="btn-close" (click)="openModal = false"></button>
        </div>

        <div class="modal-body">

          @if (submitted && logicErrors.length > 0) {
            <div class="mb-3 p-2 border rounded-3 errors">
              <span class="fw-semibold text-danger">Please fix the following errors:</span>
              <ul class="mb-0">
                @for (err of logicErrors; let eIndex = $index; track eIndex) {
                  <li class="text-danger">{{ err }}</li>
                }
              </ul>
            </div>
          }

          <div class="mb-4 row g-3">
            <div class="col-md-9">
              <label class="form-label fw-semibold">Quiz Title</label>
              <input type="text" class="form-control form-control-lg" placeholder="Enter quiz title" [(ngModel)]="quiz.title">
              @if (submitted) {
                @for (error of getErrors('title'); let i = $index; track i) {
                  <small class="text-danger">{{ error }}</small>
                }
              }
            </div>
            <div class="col-md-3">
              <label class="form-label fw-semibold">Total Marks</label>
              <input type="number" class="form-control form-control-lg" [(ngModel)]="quiz.totalScore">
              @if (submitted) {
                @for (error of getErrors('totalScore'); let i = $index; track i) {
                  <small class="text-danger">{{ error }}</small>
                }
              }
            </div>
          </div>

          <div class="mb-2"><span class="fw-semibold">Questions:</span></div>

          @for (question of quiz.questions; let qIndex = $index; track qIndex) {
            <div class="my-3 p-3 border rounded-3 question-box">
              <div class="row">
                <div class="col-md-9">
                  <label class="form-label fw-semibold">Question {{ qIndex + 1 }}:</label>
                  <input type="text" class="form-control" placeholder="Enter question text" [(ngModel)]="question.text">
                  @if (submitted) {
                    @for (error of getErrors('questionText', qIndex); let i = $index; track i) {
                      <small class="text-danger d-block">{{ error }}</small>
                    }
                  }
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-semibold">Marks:</label>
                  <input type="number" class="form-control" [(ngModel)]="question.questionMark">
                  @if (submitted) {
                    @for (error of getErrors('questionMark', qIndex); let i = $index; track i) {
                      <small class="text-danger d-block">{{ error }}</small>
                    }
                  }
                </div>
              </div>

              @for (option of question.options; let oIndex = $index; track oIndex) {
                <div class="my-3">
                  <div class="input-group">
                    <input type="text" class="form-control me-2" placeholder="Option {{ oIndex + 1 }}" [(ngModel)]="option.text">
                    <button type="button" class="btn option-btn me-2 rounded-circle d-flex align-items-center justify-content-center"
                            [ngClass]="option.isCorrect ? 'correct-option' : 'incorrect-option'"
                            (click)="markAsCorrect(qIndex, oIndex)">
                      <i class="bi bi-check-lg fs-5 text-white"></i>
                    </button>
                    <button type="button" class="btn remove-option-btn rounded-circle d-flex align-items-center justify-content-center"
                            (click)="removeOption(qIndex, oIndex)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                  @if (submitted) {
                    @for (error of getErrors('option', qIndex, oIndex); let i = $index; track i) {
                      <small class="text-danger d-block mt-1">{{ error }}</small>
                    }
                  }
                </div>
              }

              <button type="button" class="btn btn-sm add-option-btn mt-2" (click)="addOption(qIndex)">Add Option</button>
              <button type="button" class="btn btn-sm remove-question-btn mt-2 ms-2" (click)="removeQuestion(qIndex)">Remove Question</button>
            </div>
          }

          <button type="button" class="btn modal-add-question-btn rounded-pill px-4 py-2" (click)="addQuestion()">Add Question</button>
        </div>

        <div class="modal-footer border-0 d-flex justify-content-between">
          <button type="button" class="btn modal-close-btn rounded-pill px-4 py-2" (click)="openModal = false">Close</button>
          <button type="button" class="btn modal-save-btn rounded-pill px-4 py-2" (click)="saveQuiz()">Save</button>
        </div>

      </div>
    </div>
  </div>
}
