<div class="enrolled-course-page" *ngIf="!loading && course">


  <main class="course-content-container">
    <div class="main-column">
      <!-- Course Title Section -->
      <div class="course-title-section">
        <h1 class="course-title">{{ course?.name }}</h1>
        <div class="header-top">
          <span class="tag" *ngIf="course?.category">{{ course?.category }}</span>
          <div class="course-meta-inline">
            <span class="meta-item" *ngIf="modules.length > 0">
              <span class="meta-icon">üìö</span>
              {{ modules.length }} modules
            </span>
            <span class="meta-item" *ngIf="course?.estimatedDurationInHours">
              <span class="meta-icon">‚è±Ô∏è</span>
              {{ course?.estimatedDurationInHours }}h total
            </span>
            <span class="meta-item">
              <span class="meta-icon">üìú</span>
              Certificate
            </span>
          </div>
        </div>
      </div>

      <!-- Course Header Card -->
      <div class="course-header-card">
        <div class="instructor-section" *ngIf="course?.instructor">
          <img [src]="course?.instructorAvatar || 'https://storage.googleapis.com/vertex-ai-generative-ai-prod-us-east4-4654/user-4654-files/42071988-1c44-48f5-9b2f-37603c4f2a74_instructor-54.png'"
               class="instructor-avatar-small"
               [alt]="'Instructor ' + course?.instructor" />
          <div class="instructor-details">
            <p class="instructor-name-inline">Taught by {{ course?.instructor }}</p>
            <p class="instructor-subtitle" *ngIf="course?.instructorTitle || course?.estimatedDurationInHours">
              <span *ngIf="course?.instructorTitle">{{ course?.instructorTitle }}</span>
              <span *ngIf="course?.instructorTitle && course?.estimatedDurationInHours"> ‚Ä¢ </span>
              <span *ngIf="course?.estimatedDurationInHours">{{ course?.estimatedDurationInHours }}h total</span>
            </p>
          </div>
        </div>
      </div>

      <!-- Curriculum & Course Overview -->
      <div class="content-card curriculum-card" id="curriculum-section">
        <div class="curriculum-intro">
          <div class="curriculum-intro-text">
            <h2 class="card-title">Course overview</h2>
            <p class="card-description">{{ course?.description }}</p>
          </div>
        </div>

        <div class="curriculum-divider"></div>

        <div class="modules-list">
          <ng-container *ngFor="let module of modules; let moduleIdx = index; trackBy: trackByModuleId">
            <ng-container *ngIf="getModuleStatus(module.id) as moduleStatus">
              <div class="module-block"
                   [class.completed]="moduleStatus.tone === 'completed'"
                   [class.expanded]="isModuleExpanded(module.id)">
                <button type="button"
                        class="module-header"
                        (click)="toggleModule(module.id)">
                  <div class="module-header-left">
                    <div class="module-title-line">
                      Module {{ moduleIdx + 1 }} ‚Ä¢ {{ module.moduleName || module.name || module.title }}
                    </div>
                  </div>
                  <div class="module-header-right">
                    <div class="module-meta-line">{{ getModuleSummary(module) }}</div>
                  </div>
                </button>

                <div class="module-lessons" *ngIf="isModuleExpanded(module.id)">
                  <ng-container *ngFor="let lesson of (module.videos || module.lessons || []); trackBy: trackByLessonId">
                    <ng-container *ngIf="getLessonStatus(lesson) as lessonStatus">
                      <div class="lesson-card-wrapper" [class.locked]="lessonStatus.tone === 'locked'">
                        <app-list-card
                          [id]="lessonStatus.tone === 'locked' ? undefined : (lesson.id || lesson.videoId)"
                          [icon]="getLessonIcon(lesson)"
                          [text]="getLessonTitleWithIcon(lesson)"
                          [subtitle]="getLessonDurationText(lesson)"
                          [label]="getLessonStatusLabel(lessonStatus)"
                          [labelColor]="getLessonStatusColor(lessonStatus.tone)"
                          [labelIcon]="getLessonLabelIcon(lessonStatus.tone)"
                          (cardClick)="onLessonCardClick(lesson, lessonStatus, $event)">
                        </app-list-card>
                      </div>
                    </ng-container>
                  </ng-container>
                </div>
              </div>
            </ng-container>
          </ng-container>
        </div>
      </div>

      <!-- Attachments Section -->
      <div class="content-card attachments-card" id="attachments-section">
        <div class="card-header-row">
          <div>
            <h2 class="card-title">Attachments</h2>
            <p class="card-caption" *ngIf="hasAttachments">{{ courseResources.length }} files ready to download</p>
            <p class="card-caption" *ngIf="!hasAttachments">No files yet‚Äîcheck back soon</p>
          </div>
          <button type="button" class="btn btn-tertiary btn-compact" (click)="downloadAllResources()" [disabled]="!hasAttachments">
            Download all
          </button>
        </div>
        <div class="attachments-list" *ngIf="hasAttachments; else noAttachments">
          <app-list-card
            *ngFor="let resource of courseResources"
            [text]="resource.name || resource.title || resource.fileName"
            [subtitle]="(resource.moduleName ? resource.moduleName : '') + (resource.lessonName ? ' ¬∑ ' + resource.lessonName : '') + (resource.fileType ? ' ¬∑ ' + resource.fileType : '')"
            [rightText]="resource.fileSize || ''"
            [labelIcon]="'üìÑ'"
            [icon]="'üìé'"
            (cardClick)="downloadResource(resource)"
            class="attachment-card">
          </app-list-card>
        </div>
        <ng-template #noAttachments>
          <div class="empty-state">
            <span class="empty-icon">üìÅ</span>
            <p class="empty-text">No downloadable resources available for this course</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Right Sidebar -->
    <aside class="sidebar">
      <!-- Progress Card -->
      <div class="content-card progress-card">
        <h2 class="card-title">Your Progress</h2>
        <p class="card-subtitle">{{ courseProgress.percentage }}% complete</p>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="courseProgress.percentage"></div>
        </div>
        <button type="button" class="btn btn-continue-learning" (click)="startLearning()" [disabled]="!course || modules.length === 0">
          <span class="btn-icon">‚ñ∂</span>
          {{ courseProgress.percentage > 0 ? 'Resume learning' : 'Start learning' }}
        </button>
        <button type="button" class="btn btn-attachment" (click)="downloadAllResources()" *ngIf="hasAttachments" [disabled]="!hasAttachments">
          <span class="btn-icon">üìé</span>
          Download all files ({{ courseResources.length }})
        </button>
      </div>

      <!-- Course Details Card -->
      <div class="content-card details-card">
        <h2 class="card-title">Course Details</h2>
        <ul class="details-list">
          <li><strong>Pricing:</strong> {{ course?.pricing || 'Free' }}</li>
          <li><strong>Level:</strong> {{ course?.level || 'Beginner' }}</li>
          <li><strong>Language:</strong> {{ course?.language || 'English' }}</li>
          <li><strong>Category:</strong> {{ course?.category || 'General' }}</li>
        </ul>
      </div>

      <!-- Instructor Card -->
      <div class="content-card instructor-card" *ngIf="course?.instructor">
        <h2 class="card-title">Instructor</h2>
        <img [src]="course?.instructorAvatar || 'https://storage.googleapis.com/vertex-ai-generative-ai-prod-us-east4-4654/user-4654-files/42071988-1c44-48f5-9b2f-37603c4f2a74_instructor-54.png'"
             class="instructor-avatar"
             [alt]="'Instructor ' + course?.instructor" />
        <p class="instructor-name">{{ course?.instructor }}</p>
        <p class="instructor-subtitle">{{ course?.instructorTitle || 'Instructor' }}</p>
      </div>
    </aside>
  </main>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="loading">
  <div class="loader">
    <div class="spinner"></div>
    <p class="loading-text">Loading course...</p>
  </div>
</div>

<!-- Error State -->
<div class="error-container" *ngIf="error && !loading">
  <div class="error-content">
    <span class="error-icon">‚ö†Ô∏è</span>
    <h2 class="error-title">Something went wrong</h2>
    <p class="error-message">{{ error }}</p>
    <button class="btn-retry" (click)="loadCourseData()">Try Again</button>
  </div>
</div>
