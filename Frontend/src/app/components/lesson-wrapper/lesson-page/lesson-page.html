<div class="lesson-page">
  <div class="content-grid" [class.sidebar-hidden]="!showSidebar">
    <aside class="lesson-list">
      <div class="list-header">
        <div class="course-content">Course content</div>
        <div class="progress">{{ (lesson?.progress || 0) }}% done</div>
      </div>

      <div class="course-progress">
        <div class="bar"><div class="fill" [style.width]="(lesson?.progress || 0) + '%'" ></div></div>
      </div>

  <div *ngIf="loading && (!fullModules || fullModules.length === 0) && lessons.length === 0" class="loader">Loading...</div>
  <div *ngIf="!loading && lessons.length === 0 && (!fullModules || fullModules.length === 0)" class="empty">No lessons</div>

      <div *ngFor="let module of getGroupedModules(); trackBy: trackByModule" class="module-block">
        <div class="module-label">
          <div class="icon">≡</div>
          <div class="module-title">{{ module.title }}</div>
          <div class="spacer"></div>
          <button class="collapse-btn" aria-expanded="{{ !moduleCollapsed[module.key] }}" (click)="toggleModuleCollapse(module.key)">
            <span *ngIf="!moduleCollapsed[module.key]">−</span>
            <span *ngIf="moduleCollapsed[module.key]">+</span>
          </button>
        </div>

        <div *ngIf="!moduleCollapsed[module.key]">
          <div *ngFor="let l of module.items; trackBy: trackByLesson" (click)="selectLesson(l.id || l.videoId)" [class.active]="(lesson && (lesson.id || lesson.videoId) === (l.id || l.videoId))" class="lesson-item">
            <div class="icon">▶</div>
            <div class="title">{{ l.title || l.name || ('Lesson ' + (l.order || l.id)) }}</div>
            <div class="duration">{{ l.durationSeconds ? (l.durationSeconds/60 | number:'1.0-0') + ':00' : '' }}</div>
          </div>
        </div>
      </div>
    </aside>

    <main class="lesson-main">
      <div *ngIf="loadingLesson" style="padding:12px;text-align:center">Loading lesson...</div>
      <div class="course-header">
        <div class="left">
          <div class="course-title">{{ courseTitle || 'Course' }}</div>
          <div class="module-title" *ngIf="selectedModuleTitle">{{ selectedModuleTitle }}</div>
        </div>
        <div class="center"><span class="status">Enrolled</span></div>
        <div class="right">
          <button class="btn-resources">Resources</button>
          <button class="btn-resume">Resume</button>
          <button class="btn-toggle-sidebar small" (click)="toggleSidebar()" title="Toggle sidebar">{{ showSidebar ? 'Hide' : 'Show' }}</button>
        </div>
      </div>

      <div class="video-wrap">
  <video id="player" controls crossorigin playsinline [attr.poster]="lesson?.thumbnail?.fileDownloadUrl || ''">
          <source *ngIf="videoSrc" [src]="videoSrc" type="video/mp4" />
          Your browser does not support HTML5 video.
        </video>
        <!-- minimal controls - floating next removed per request -->
      </div>

      <div class="video-nav">
        <button class="btn-prev" (click)="prevLesson()">Prev</button>
        <div class="lesson-info">Lesson {{ lessonIndex }} of {{ lessonCount }} • {{ lesson?.durationSeconds ? (lesson.durationSeconds/60 | number:'1.0-0') + ':00' : '' }}</div>
        <button class="btn-next" (click)="nextLesson()">Next</button>
      </div>
      <!-- compact info row (three cards) under the video -->
      <div class="info-grid">
        <div class="info-card info-learn">
          <div class="card-header">
            <h4>What you'll learn</h4>
            <div class="card-sub">Key outcomes from this lesson</div>
          </div>
          <ul class="dot-list" *ngIf="whatYouWillLearnList && whatYouWillLearnList.length">
            <li *ngFor="let item of whatYouWillLearnList">{{ item }}</li>
          </ul>
          <div *ngIf="!whatYouWillLearnList || whatYouWillLearnList.length === 0" class="muted">No bullet points available.</div>
        </div>

        <div class="info-card info-prereq">
          <div class="card-header">
            <h4>Prerequisites</h4>
            <div class="card-sub">What we expect you to know</div>
          </div>
          <ul class="dot-list" *ngIf="prerequisitesList && prerequisitesList.length">
            <li *ngFor="let p of prerequisitesList">{{ p }}</li>
          </ul>
          <div *ngIf="!prerequisitesList || prerequisitesList.length === 0" class="muted">No prerequisites.</div>
        </div>

        <!-- Attachments moved to right-side panel to avoid duplication -->
      </div>

    </main>

    <!-- Right sidebar: progress, lesson details, instructor -->
    <aside class="side-col">
      <!-- persistent attachments toggle (always visible) -->
      <div class="attachments-toggle persistent">
        <button class="link small" (click)="toggleAttachmentsHide()">{{ attachmentsHidden ? 'Show attachments' : 'Hide attachments' }}</button>
      </div>
      <div class="progress-card">
        <div class="progress-title">Your progress</div>
        <div class="progress-bar"><div class="progress-fill" [style.width]="(lesson?.progress || 0) + '%'">&nbsp;</div></div>
        <div class="progress-pct">{{ (lesson?.progress || 0) }}% complete</div>
      </div>
      <div class="details-card">
        <h4>Lesson details</h4>
        <ul>
          <li><strong>Level:</strong> {{ lesson?.level || 'Beginner' }}</li>
          <li><strong>Language:</strong> {{ lesson?.language || 'English' }}</li>
          <li><strong>Category:</strong> {{ lesson?.category || 'General' }}</li>
          <li><strong>Resources:</strong> {{ attachments.length || 0 }} files</li>
        </ul>
      </div>

      <div class="instructor-card">
        <div class="instructor-avatar"> <img [src]="lesson?.instructor?.avatarUrl || '/assets/default-avatar.png'" alt="Instructor"/> </div>
        <div class="instructor-meta">
          <div class="name">{{ lesson?.instructor?.name || 'Instructor' }}</div>
          <div class="role">{{ lesson?.instructor?.title || '' }}</div>
        </div>
      </div>

      <div *ngIf="!attachmentsHidden" class="attachments-panel">
        <div class="tabs">
          <div class="left-tabs">
            <button (click)="setAttachmentsTab('attachments')" [class.active]="attachmentsTab==='attachments'">Attachments</button>
            <button (click)="setAttachmentsTab('quizzes')" [class.active]="attachmentsTab==='quizzes'">Quizzes</button>
          </div>
          <div class="spacer"></div>
        </div>

        <div class="tab-body" role="region" aria-label="Attachments and quizzes">
          <div *ngIf="attachmentsTab === 'attachments'">
            <div *ngIf="attachments && attachments.length; else noAttachSide">
              <div class="attachments">
                <div *ngFor="let a of attachments" class="attachment-item">
                  <div class="left">
                    <div class="name">{{ a.fileName }}</div>
                    <div class="size">{{ a.fileSize || 'Unknown size' }}</div>
                  </div>
                  <div class="right">
                    <a class="btn-download" [href]="a.fileDownloadUrl" target="_blank" rel="noopener noreferrer">Open</a>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #noAttachSide>
              <div class="empty">No attachments</div>
            </ng-template>
          </div>

          <div *ngIf="attachmentsTab === 'quizzes'">
            <div *ngIf="quizzes && quizzes.length; else noQuizzes">
              <ul>
                <li *ngFor="let q of quizzes" class="attachment-item" style="cursor:pointer" (click)="showQuiz(q)">
                  <div class="left">
                    <div class="name">{{ q.title || q.name || ('Quiz ' + (q.id || '')) }}</div>
                  </div>
                  <div class="right">
                    <div class="meta">{{ q.totalScore ? (q.totalScore + ' pts') : '' }} {{ q.isActive ? '' : '(inactive)' }}</div>
                  </div>
                </li>
              </ul>
            </div>
            <ng-template #noQuizzes>
              <div class="empty">No quizzes available</div>
            </ng-template>

            <div *ngIf="selectedQuiz" class="info-card" style="margin-top:10px">
              <h4>{{ selectedQuiz.title }}</h4>
              <div><strong>Total:</strong> {{ selectedQuiz.totalScore }} pts</div>
              <div *ngIf="selectedQuiz.questions && selectedQuiz.questions.length">
                <div *ngFor="let qq of selectedQuiz.questions" style="margin-top:8px">
                  <div><strong>{{ qq.text }}</strong> <small>({{ qq.questionMark }} pts)</small></div>
                  <ul>
                    <li *ngFor="let o of qq.options">{{ o.text }} <span *ngIf="o.isCorrect">✅</span></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>
  <!-- Move lesson-details below grid so wider content doesn't shift side columns -->
  <section class="lesson-details fullwidth">
    <div class="container">
      <h3 class="lesson-title">{{ lesson?.title || lesson?.name || 'Lesson' }}</h3>
      <div class="description-box">
        <h4>Description</h4>
        <div class="explanation" [innerHTML]="explanationHtml"></div>
        <div class="tip-box">Tip: Make sure to have your development environment set up before starting.</div>
      </div>
    </div>
  </section>
</div>
