<div class="page-container" *ngIf="!loading && courseData">


  <main class="main-content">
    <article class="course-details">
      <header class="course-header card">
        <div>
          <h2>{{ courseData.name }}</h2>
          <p class="course-subtitle" *ngIf="courseData.description">{{ courseData.description }}</p>
        </div>
        <div class="tag tag-light" *ngIf="courseData.category">{{ courseData.category }}</div>
      </header>

      <div class="card">
        <section class="course-intro">
          <img class="course-image" [src]="courseData.thumbnailUrl" alt="Course preview" />
          <div class="intro-content">
            <div class="course-highlights">
              <div class="tag tag-cyan" *ngIf="courseData.estimatedDurationInHours">
                {{ courseData.estimatedDurationInHours }}h content
              </div>
              <div class="tag tag-cyan" *ngIf="courseData.modules?.length">
                {{ courseData.modules?.length || 0 }} modules
              </div>
              <div class="tag tag-cyan" *ngIf="courseData.certificate !== false">Certificate</div>
            </div>
            <p class="course-description" *ngIf="courseData.description">{{ courseData.description }}</p>
            <div class="course-meta">
              <div class="meta-item" *ngIf="courseData.difficultyLevel">Level: {{ courseData.difficultyLevel }}</div>
              <div class="meta-item" *ngIf="courseData.language">Language: {{ courseData.language }}</div>
              <div class="meta-item" *ngIf="courseData.enrolledCount">
                Students: {{ courseData.enrolledCount | number }}
              </div>
            </div>
          </div>
        </section>
      </div>

      <section class="card">
        <h3>What you'll learn</h3>
        <div class="feature-list" *ngIf="courseData.whatYouWillLearn?.length; else learnEmpty">
          <div *ngFor="let item of courseData.whatYouWillLearn" class="feature-item">
            {{ item }}
          </div>
        </div>
        <ng-template #learnEmpty>
          <div class="empty-state">
            <span class="empty-icon">üí°</span>
            <p class="empty-text">Learning objectives will be added soon.</p>
          </div>
        </ng-template>
      </section>

      <section class="card">
        <h3>Modules overview</h3>
        <div class="module-list" *ngIf="courseData.modules?.length; else modulesEmpty">
          <div *ngFor="let module of courseData.modules" class="module-item" [class.locked]="!module.active">
            <div class="module-icon-wrapper">
              <svg *ngIf="!module.active" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>
              <svg *ngIf="module.active" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2z"/></svg>
            </div>
            <div class="module-info">
              <h4>{{ module.name }}</h4>
              <p *ngIf="module.description">{{ module.description }}</p>
              <div class="module-meta">
                <span *ngIf="module.estimatedDuration" class="meta-item">Duration: {{ module.estimatedDuration }} min</span>
                <span *ngIf="module.numberOfVideos" class="meta-item">Videos: {{ module.numberOfVideos }}</span>
              </div>
            </div>
            <div class="tag" [ngClass]="{
                'tag-light': !module.active,
                'tag-preview': module.active && module.previewAvailable,
                'tag-available': module.active && !module.previewAvailable
              }">
              {{ !module.active ? 'Locked' : (module.previewAvailable ? 'Preview lesson' : 'Available') }}
            </div>
          </div>
        </div>
        <ng-template #modulesEmpty>
          <div class="empty-state">
            <span class="empty-icon">üì¶</span>
            <p class="empty-text">Course modules will be available soon.</p>
          </div>
        </ng-template>
      </section>

      <section class="card" *ngIf="courseData.resources?.length">
        <h3>Included resources</h3>
        <div class="feature-list">
          <div *ngFor="let resource of courseData.resources" class="feature-item">
            {{ resource }}
          </div>
        </div>
      </section>

      <section class="card reviews-card">
        <header class="reviews-header">
          <div>
            <h3>Student reviews</h3>
            <p class="reviews-summary" *ngIf="courseData.reviewCount">
              {{ courseData.averageRating | number:'1.1-1' }} average ¬∑ {{ courseData.reviewCount }} reviews
            </p>
            <p class="reviews-summary" *ngIf="!courseData.reviewCount">No reviews yet</p>
          </div>
          <div class="rating-pill">
            <app-star-rating [rating]="courseData.averageRating || 0"></app-star-rating>
          </div>
        </header>

        <div class="reviews-list" [class.expanded]="showAllReviews">
          <div class="empty-state" *ngIf="reviews?.length === 0 && !isReloadingReviews">
            <span class="empty-icon">üí¨</span>
            <p class="empty-text">Be the first to review this course.</p>
          </div>

          <article class="review-card" *ngFor="let review of displayedReviews">
            <div class="review-header">
              <div class="reviewer-info">
                <div class="avatar-circle">
                  {{ review.isAnonymous ? 'A' : (review.userId ? review.userId.toString().charAt(0) : 'U') }}
                </div>
                <div>
                  <strong>{{ review.isAnonymous ? 'Anonymous learner' : ('Student ' + review.userId) }}</strong>
                  <span>{{ review.createdAt | date:'MMM d, yyyy' }}</span>
                </div>
              </div>
              <div class="review-rating">
                <span class="stars">{{ '‚≠ê'.repeat(review.rating || 0) }}</span>
                <span class="score">{{ review.rating || '‚Äî' }}</span>
              </div>
            </div>
            <p class="review-body">{{ review.feedbackText }}</p>
          </article>
        </div>

        <div class="reviews-actions" *ngIf="reviewsTotalElements > 3">
          <button class="btn btn-secondary" *ngIf="reviewsPage + 1 < reviewsTotalPages" (click)="loadMoreReviews()" [disabled]="isReloadingReviews">
            <span *ngIf="!isReloadingReviews">Load {{ nextLoadCount }} more reviews</span>
            <span *ngIf="isReloadingReviews">Loading‚Ä¶</span>
          </button>
          <button class="btn btn-secondary" *ngIf="showAllReviews && reviewsPage + 1 >= reviewsTotalPages" (click)="collapseReviews()">
            Show less
          </button>
        </div>

        <div class="review-form">
          <h4>Share your experience</h4>
          <div class="form-row">
            <label>Your rating</label>
            <app-star-rating [editable]="true" [rating]="reviewRating" (ratingChange)="reviewRating = $event"></app-star-rating>
          </div>
          <label for="review-text">Your review</label>
          <textarea id="review-text" rows="4" [(ngModel)]="reviewText" placeholder="What did you think about this course?" ></textarea>
          <label class="checkbox">
            <input type="checkbox" [(ngModel)]="reviewAnonymous" />
            <span>Post anonymously</span>
          </label>
          <button class="btn btn-primary" (click)="submitReview()" [disabled]="isSubmitting || !reviewText || !reviewRating">
            <span *ngIf="!isSubmitting">Submit review</span>
            <span *ngIf="isSubmitting">Submitting‚Ä¶</span>
          </button>
        </div>
      </section>
    </article>

    <aside class="sidebar">
      <div class="card">
        <header class="sidebar-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2-2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v1h14V4a1 1 0 0 0-1-1H2zm13 4H1v5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7z"/><path d="M2 10a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1z"/></svg>
          <h3>Get access</h3>
        </header>

        <div class="sidebar-content">
          <div class="price-info">
            <span class="price">{{ courseData.currency }}{{ (courseData.oneTimePrice ?? 0) | number:'1.2-2' }}</span>
            <span class="tag tag-light">One-time</span>
          </div>

          <div class="plan-chooser" *ngIf="courseData.hasSubscriptionPlans">
            <p>Or choose a plan</p>
            <div class="plan-options">
              <button class="plan-btn" *ngIf="courseData.plans?.monthly" (click)="onSelectPlan('monthly', courseData.plans?.monthly)">Monthly ‚Ä¢ {{ courseData.currency }}{{ courseData.plans?.monthly | number:'1.2-2' }}</button>
              <button class="plan-btn" *ngIf="courseData.plans?.threeMonths" (click)="onSelectPlan('3-months', courseData.plans?.threeMonths)">3 Months ‚Ä¢ {{ courseData.currency }}{{ courseData.plans?.threeMonths | number:'1.2-2' }}</button>
              <button class="plan-btn" *ngIf="courseData.plans?.sixMonths" (click)="onSelectPlan('6-months', courseData.plans?.sixMonths)">6 Months ‚Ä¢ {{ courseData.currency }}{{ courseData.plans?.sixMonths | number:'1.2-2' }}</button>
              <button class="plan-btn" *ngIf="courseData.plans?.annual" (click)="onSelectPlan('12-months', courseData.plans?.annual)">12 Months ‚Ä¢ {{ courseData.currency }}{{ courseData.plans?.annual | number:'1.2-2' }}</button>
            </div>
          </div>

          <div class="action-buttons">
            <button class="btn btn-primary btn-full" (click)="onSubscribeOneTime()">Subscribe to course</button>
            <button class="btn btn-secondary btn-full" (click)="onPreview()">Preview first lesson</button>
            <p class="guarantee">7-day refund guarantee. Access all modules and resources.</p>
          </div>

          <hr class="divider" />

          <div class="instructor-info" *ngIf="courseData.instructor">
            <img class="avatar" [src]="courseData.instructorAvatar || 'https://ui-avatars.com/api/?name=' + (courseData.instructor || 'I') + '&background=7c3aed&color=fff&size=64'" [alt]="courseData.instructor" />
            <div>
              <h4>{{ courseData.instructor }}</h4>
              <p *ngIf="courseData.instructorTitle">{{ courseData.instructorTitle }}</p>
            </div>
          </div>

          <div class="info-pills">
            <div class="info-item" *ngIf="courseData.lastUpdated">Last updated: {{ courseData.lastUpdated | date:'MMM yyyy' }}</div>
            <div class="info-item" *ngIf="courseData.language">Language: {{ courseData.language }}</div>
            <div class="info-item" *ngIf="courseData.subtitles?.length">Subtitles: {{ courseData.subtitles?.join(', ') }}</div>
          </div>
        </div>
      </div>

      <div class="card" *ngIf="courseData.tags?.length">
        <h3>Topics covered</h3>
        <div class="tags-list">
          <span class="tag tag-light" *ngFor="let tag of courseData.tags | slice:0:6">{{ tag.name || tag }}</span>
        </div>
      </div>
    </aside>
  </main>

  <div *ngIf="error" class="error-card">
    <p>{{ error }}</p>
    <button class="btn btn-primary" (click)="courseId && loadCourse(courseId)">Retry</button>
  </div>
</div>

<div *ngIf="loading" class="spinner-container">
  <div class="spinner"></div>
  <div class="loading-text">Loading course‚Ä¶</div>
</div>
